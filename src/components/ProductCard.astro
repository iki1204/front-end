---
const { producto } = Astro.props;
const API_URL = import.meta.env.VITE_STRAPI_URL;

const medias: any[] = [
  // imagen como array de media
  ...(Array.isArray(producto?.imagen) ? producto.imagen : []),
  // imagen como single media
  ...(producto?.imagen?.data?.attributes ? [producto.imagen.data.attributes] : []),
  // imagenes como relation multiple
  ...(Array.isArray(producto?.imagenes?.data) ? producto.imagenes.data.map((m:any) => m.attributes) : []),
].filter(Boolean);

const path =
  medias[0]?.formats?.medium?.url ??
  medias[0]?.formats?.large?.url ??
  medias[0]?.url ??
  null;
var imgUrl = path ? `${API_URL}${path}` : "/images/placeholder.svg";


if (imgUrl == null) {
  imgUrl = "/images/placeholder.svg";
}

const srcset = medias[0]?.formats
  ? [
      medias[0].formats.thumbnail?.url && `${API_URL}${medias[0].formats.thumbnail.url} 156w`,
      medias[0].formats.small?.url && `${API_URL}${medias[0].formats.small.url} 500w`,
      medias[0].formats.medium?.url && `${API_URL}${medias[0].formats.medium.url} 750w`,
      medias[0].formats.large?.url && `${API_URL}${medias[0].formats.large.url} 1000w`,
      medias[0].url && `${API_URL}${medias[0].url} ${(medias[0].width ?? 1200)}w`,
    ].filter(Boolean).join(', ')
  : undefined;
const sizes = "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw";

const priceFormatter = new Intl.NumberFormat("es-PE", {
  style: "currency",
  currency: "USD",
  minimumFractionDigits: 2,
});

const slug = producto?.ID_Nombre ?? producto?.slug ?? producto?.id;
const priceLabel = typeof producto?.precio === "number" ? priceFormatter.format(producto.precio) : "Consultar";
---

<article class="group flex h-full flex-col rounded-2xl border border-zinc-200 p-4 shadow-sm transition hover:-translate-y-1 hover:shadow-lg dark:border-zinc-800 dark:bg-zinc-900">
  <a href={`/producto/${slug}`} class="flex flex-1 flex-col">
    <div class="relative overflow-hidden rounded-xl bg-zinc-100 dark:bg-zinc-800">
      <img
        src={imgUrl}
        alt={producto?.nombre ?? "Producto"}
        sizes={srcset ? sizes : undefined}
        class="h-56 w-full object-contain transition duration-300 group-hover:scale-105"
        decoding="async"
        loading="lazy"
      />
    </div>
    <div class="mt-4 flex flex-1 flex-col gap-2">
      <h3 class="line-clamp-2 text-lg font-semibold text-zinc-900 dark:text-white">
        {producto?.nombre}
      </h3>
      <p class="text-sm text-zinc-500 dark:text-zinc-400">Código: {producto?.codigo ?? "N/A"}</p>
      <div class="mt-auto flex items-center justify-between">
        <p class="text-lg font-bold text-red-500">{priceLabel}</p>
      </div>
    </div>
    
 </a>
  <div class="mt-4 flex items-center justify-between gap-2">
    <a
      href={`/producto/${slug}`}
      class="rounded-full border border-transparent px-4 py-2 text-sm font-semibold text-primary transition hover:border-primary hover:bg-primary/10"
    >
      Ver detalles
    </a>
    <button
      type="button"
      data-action="add-to-cart"
      data-product-id={producto?.id ?? producto?.ID_Producto ?? producto?.codigo ?? slug}
      data-product-name={producto?.nombre ?? "Producto"}
      data-product-price={typeof producto?.precio === "number" ? producto.precio : ""}
      data-product-image={imgUrl}
      data-product-url={`/producto/${slug}`}
      class="rounded-full bg-primary px-4 py-2 text-sm font-semibold text-white transition hover:brightness-110 focus:outline-none focus:ring-2 focus:ring-primary/60"
    >
      Añadir al carrito
    </button>
  </div>