---
import BaseLayout from "../../layouts/Layout.astro";
import Container from "../../components/Container.astro";
import { BlocksRenderer} from "@strapi/blocks-react-renderer";
import { getProductoBySlug, getGlobalData, getCategorias, getProductos, getMarcas } from "../../lib/api";

const normalizeCollection = (collection: any[] = []) =>
  collection.map((item) => (item?.attributes ? { id: item.id, ...item.attributes } : item));

export async function getStaticPaths() {
  const PAGE_SIZE = 100;
  const productos: Record<string, unknown>[] = [];
  let page = 1;
  let pageCount = 1;

  do {
    const response = await getProductos({
      "pagination[page]": page,
      "pagination[pageSize]": PAGE_SIZE,
    });

    const pageItems = normalizeCollection(response?.data ?? []);
    productos.push(...pageItems);

    const pagination = response?.meta?.pagination;
    pageCount = pagination?.pageCount ?? pageCount;
    page += 1;
  } while (page <= pageCount);

  return productos
    .map((producto) => {
      const slug = producto?.ID_Nombre ?? producto?.slug ?? (producto?.id ? String(producto.id) : null);

      if (!slug) {
        return null;
      }

      return {
        params: { slug },
        props: { preloadedProducto: producto },
      };
    })
    .filter(
      (
        value,
      ): value is {
        params: { slug: string };
        props: { preloadedProducto: Record<string, unknown> };
      } => Boolean(value),
    );
}

const { params } = Astro;
const slug = params.slug;
const preloadedProducto = Astro.props?.preloadedProducto;

if (!slug) {
  throw new Error("No se proporcionó un identificador de producto");
}

const [productoResponse, global, categoriasResponse, marcasResponse] = await Promise.all([
  preloadedProducto ? Promise.resolve({ data: [preloadedProducto] }) : getProductoBySlug(slug),
  getGlobalData(),
  getCategorias(),
  getMarcas()
]);

const producto = normalizeCollection(productoResponse?.data ?? [])[0];

if (!producto) {
  return Astro.redirect("/tienda", 302);
}

const categorias = normalizeCollection(categoriasResponse?.data ?? []);
const marcas = normalizeCollection(marcasResponse?.data ?? []);
console.log(producto.ID_marca)
const categoriaActual = categorias.find((categoria) =>
  categoria?.ID_Categoria === producto?.ID_Categoria || categoria?.id === producto?.ID_Categoria
);
const marcaActual = marcas.find((marca) =>
  marca?.ID_Marca === producto?.ID_Marca || null
)



const API_URL = import.meta.env.VITE_STRAPI_URL;
const galeriasPosibles = [producto?.imagen, producto?.imagenes?.data];

const firstArray = galeriasPosibles.find(a => Array.isArray(a) && a.length);
const firstItem = firstArray?.[0] ?? null;
const mainPath =
  firstItem?.formats?.medium?.url ??
  firstItem?.formats?.large?.url ??
  firstItem?.url ??
  firstItem?.attributes?.formats?.medium?.url ??
  firstItem?.attributes?.url ??
  null;
const mainImage = mainPath ? `${API_URL}${mainPath}` : "/images/placeholder.svg";
const galleryItems = galeriasPosibles
  .flat()
  .filter(Boolean)
  .map((item) => {
    const url = item?.url ?? item?.attributes?.url ?? item?.attributes?.formats?.medium?.url ?? null;
    return url && API_URL ? `${API_URL}${url}` : null;
  })
  .filter((value, index, array) => Boolean(value) && array.indexOf(value) === index)
  .filter((imageUrl) => imageUrl !== mainImage);

  
const datasheetEntries: any[] = [
  ...(Array.isArray(producto?.datasheets) ? producto.datasheets : []),
  ...(Array.isArray(producto?.datasheets?.data)
    ? producto.datasheets.data.map((item: any) => item?.attributes ?? item)
    : []),
  ...(producto?.datasheets?.data?.attributes ? [producto.datasheets.data.attributes] : []),
].filter(Boolean);

const datasheetLinks = datasheetEntries
  .map((item) => {
    const url = item?.url ?? item?.formats?.pdf?.url ?? null;
    if (!url) return null;

    const absoluteUrl = url.startsWith("http") ? url : `${API_URL ?? ""}${url}`;
    const label = item?.name ?? item?.alternativeText ?? item?.caption ?? "Ficha técnica";

    return { url: absoluteUrl, label };
  })
  .filter(Boolean);


const priceFormatter = new Intl.NumberFormat("es-PE", {
  style: "currency",
  currency: "USD",
  minimumFractionDigits: 2,
});

const precio = typeof producto?.precio === "number" ? priceFormatter.format(producto.precio) : "Consultar";
var descripcion = producto?.descripcion;

const stock = typeof producto?.cantidad_stock === "number" ? producto.cantidad_stock : null;
---

<BaseLayout global={global}>
  <Container> 
  <article class="z-40 mx-auto flex max-w-6xl flex-col gap-12 px-6 py-12 ">
    <button
      type="button"
      onclick="window.history.back()"
      class="inline-flex items-center gap-2 w-auto cursor-pointer self-start text-sm font-bold text-primary hover:underline"
    >
      ← Volver a la tienda
    </button>
    <div class="grid gap-10 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
      <section class="space-y-6">
        <div class="overflow-hidden rounded-3xl shadow-7xl border border-zinc-300 dark:bg-zinc-900 dark:border-red-800 p-6 shadow-sm  ">
          <img
            id="main-image"
            src={mainImage}
            alt={producto?.nombre ?? "Producto"}
            class="h-full w-full max-h-[480px] rounded-2xl object-contain border-0 "
            loading="lazy"
          />
        </div>
        {galleryItems.length > 0 && (
          <div id="thumbs" class="grid grid-cols-2 gap-4 sm:grid-cols-4">
            {galleryItems.map((imageUrl) => (
              <button
              class="cursor-pointer thumb relative overflow-hidden rounded-2xl border border-zinc-300 bg-white p-2 dark:border-zinc-800 dark:bg-zinc-900"
              data-src={imageUrl}
              type="button"
              aria-label="Cambiar imagen"
            >
              <img
                src={imageUrl}
                alt={`Vista adicional de ${producto?.nombre}`}
                class="h-32 w-full object-cover pointer-events-none"
                loading="lazy"
              />
            </button>
            ))}
          </div>
        )}
      </section>

      <section class="flex flex-col gap-6 rounded-3xl border border-zinc-300 p-8 shadow-sm dark:border-red-800 dark:bg-zinc-900">
        <header class="space-y-5">
          <span class="inline-flex  items-center rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-primary/70 dark:bg-white/70">
            {categoriaActual?.nombre  ?? "Sin categoría"}
          </span>
          <span class="inline-flex items-center rounded-full bg-red-800 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white">
            {marcaActual?.nombre  ?? "Sin marca"}
          </span>
          <h1 class="text-3xl font-bold text-zinc-900 dark:text-white">{producto?.nombre}</h1>
          <p class="text-sm text-zinc-500 dark:text-zinc-400">Código: {producto?.codigo ?? "N/A"}</p>
        </header>

        <div class="space-y-2">
          <p class="hidden text-3xl font-bold text-red-500" data-auth-visible="authenticated">{precio}</p>
          <p class="text-sm text-red-500 dark:text-red-300" data-auth-visible="guest">
            Inicia sesión para ver mas de este producto.
          </p>
          {stock !== null ? (
            <p class="text-sm text-zinc-500 dark:text-zinc-400">Stock disponible: {stock} unidades</p>
          ) : null}
        </div>

        <section class="prose space-y-4">
          <h2 class="text-lg font-semibold text-zinc-900 dark:text-white">Descripción</h2>
          <div class="prose dark:prose-invert mx-auto">
             {Array.isArray(descripcion) && descripcion.length > 0 && descripcion.some(block => Array.isArray(block.children) && block.children.length > 0)
              ? <BlocksRenderer content={descripcion} />
              : <p class="text-sm text-zinc-900 dark:text-zinc-200">No hay descripción para este producto.</p>
            }
          </div>
        </section>

          {datasheetLinks.length > 0 ? (
          <section class="space-y-3" data-auth-visible="authenticated">
            <h2 class="text-lg font-semibold text-zinc-900 dark:text-white">Fichas técnicas</h2>
            <ul class="space-y-2 text-sm text-zinc-700 dark:text-zinc-200">
              {datasheetLinks.map((file) => (
                <li class="flex items-center gap-3 rounded-xl border border-zinc-200 px-4 py-3 dark:border-zinc-800">
                  <svg aria-hidden="true" class="h-5 w-5 text-primary" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M15.50 2.75a.75.75 0 0 1 1.5 0v12.75a4.75 5 0 1 1-9.5 0V6.25a2.75 4 0 1 1 5.5 0v8.75a1.75 1.75 0 1 1-3.5 0V7.75a.75.75 0 0 1 1.5 0v7.25a.25.25 0 1 0 .5 0V6.25a1.25 1.25 0 1 0-2.5 0v9.25a3.25 3.25 0 1 0 6.5 0z" />
                  </svg>
                  <a
                    href={file.url}
                    target="_blank"
                    rel="noreferrer"
                    class="flex-1 truncate font-semibold text-primary hover:underline"
                  >
                    {file.label}
                  </a>
                  <span class="text-xs text-zinc-500 dark:text-zinc-400">PDF</span>
                </li>
              ))}
            </ul>
          </section>
        ) : null}


        <div class="flex flex-col gap-3 sm:flex-row">
           <button
                type="button"
                data-auth-visible="authenticated"
                data-action="add-to-cart"
                class="w-full cursor-pointer rounded-full bg-primary px-4 py-2 text-sm font-semibold text-white transition hover:brightness-110"
                data-product-id={producto?.id ?? producto?.ID_Producto ?? producto?.codigo ?? slug}
                data-product-name={producto?.nombre ?? "Producto"}
                data-product-price={typeof producto?.precio === "number" ? producto.precio : ""}
                data-product-image={mainImage}
                data-product-url={`/producto/${slug}`}
                >
                Añadir al carrito
            </button>
          <a
            href="/tienda#contacto"
            class="w-full rounded-full border border-primary px-6 py-3 text-center text-sm font-semibold text-primary transition hover:bg-primary/10"
          >
            Contactar un asesor
          </a>
        </div>
      </section>
    </div>
  </article>
  </Container>
</BaseLayout>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const mainImg = document.getElementById("main-image");
    const thumbsRoot = document.getElementById("thumbs");
    if (!mainImg || !thumbsRoot) return;

    // Estado: URLs absolutas
    const mainState = { src: mainImg.getAttribute("src") };
    let thumbs = Array.from(thumbsRoot.querySelectorAll("[data-src]"))
      .map((el) => el.getAttribute("data-src"))
      .filter(Boolean);

    // Delegación de eventos para clicks en las miniaturas
    thumbsRoot.addEventListener("click", (e) => {
      const btn = (e.target as HTMLElement).closest("[data-src]");
      if (!btn) return;

      const newMain = btn.getAttribute("data-src");
      if (!newMain || newMain === mainState.src) return;

      // 1) Cambia imagen principal
      const prevMain = mainState.src;
      mainState.src = newMain;
      mainImg.setAttribute("src", newMain);

      // 2) Reordena: quita clicada y agrega la anterior principal al final
      thumbs = thumbs.filter((u) => u !== newMain);
      thumbs.push(prevMain);

      // 3) Re-renderiza miniaturas
      renderThumbs();
    });

    function renderThumbs() {
      // Limpia y vuelve a dibujar
      thumbsRoot.innerHTML = thumbs
        .map(
          (src) => `
          <button
            class="cursor-pointer thumb relative overflow-hidden rounded-2xl border border-zinc-200 bg-white p-2 dark:border-zinc-800 dark:bg-zinc-900"
            data-src="${src}"
            type="button"
            aria-label="Cambiar imagen"
          >
            <img src="${src}" alt="Vista adicional" class="h-32 w-full object-cover pointer-events-none" loading="lazy" />
          </button>`
        )
        .join("");
    }
  });
</script>
