---
import BaseLayout from "../../layouts/Layout.astro";
import { getProductoBySlug, getGlobalData, getCategorias, getProductos } from "../../lib/api";

const normalizeCollection = (collection: any[] = []) =>
  collection.map((item) => (item?.attributes ? { id: item.id, ...item.attributes } : item));

export async function getStaticPaths() {
  const PAGE_SIZE = 100;
  const productos: Record<string, unknown>[] = [];
  let page = 1;
  let pageCount = 1;

  do {
    const response = await getProductos({
      "pagination[page]": page,
      "pagination[pageSize]": PAGE_SIZE,
    });

    const pageItems = normalizeCollection(response?.data ?? []);
    productos.push(...pageItems);

    const pagination = response?.meta?.pagination;
    pageCount = pagination?.pageCount ?? pageCount;
    page += 1;
  } while (page <= pageCount);

  return productos
    .map((producto) => {
      const slug = producto?.ID_Nombre ?? producto?.slug ?? (producto?.id ? String(producto.id) : null);

      if (!slug) {
        return null;
      }

      return {
        params: { slug },
        props: { preloadedProducto: producto },
      };
    })
    .filter(
      (
        value,
      ): value is {
        params: { slug: string };
        props: { preloadedProducto: Record<string, unknown> };
      } => Boolean(value),
    );
}

const { params } = Astro;
const slug = params.slug;
const preloadedProducto = Astro.props?.preloadedProducto;

if (!slug) {
  throw new Error("No se proporcionó un identificador de producto");
}

const [productoResponse, global, categoriasResponse] = await Promise.all([
  preloadedProducto ? Promise.resolve({ data: [preloadedProducto] }) : getProductoBySlug(slug),
  getGlobalData(),
  getCategorias(),
]);

const producto = normalizeCollection(productoResponse?.data ?? [])[0];

if (!producto) {
  return Astro.redirect("/tienda", 302);
}

const categorias = normalizeCollection(categoriasResponse?.data ?? []);
const categoriaActual = categorias.find((categoria) =>
  categoria?.ID_Categoria === producto?.ID_Categoria || categoria?.id === producto?.ID_Categoria
);


const API_URL = import.meta.env.VITE_STRAPI_URL;
const galeriasPosibles = [producto?.imagen, producto?.imagenes?.data];

const firstArray = galeriasPosibles.find(a => Array.isArray(a) && a.length);
const firstItem = firstArray?.[0] ?? null;
const mainPath =
  firstItem?.formats?.medium?.url ??
  firstItem?.formats?.large?.url ??
  firstItem?.url ??
  firstItem?.attributes?.formats?.medium?.url ??
  firstItem?.attributes?.url ??
  null;
const mainImage = mainPath ? `${API_URL}${mainPath}` : "/images/placeholder.svg";
const galleryItems = galeriasPosibles
  .flat()
  .filter(Boolean)
  .map((item) => {
    const url = item?.url ?? item?.attributes?.url ?? item?.attributes?.formats?.medium?.url ?? null;
    return url && API_URL ? `${API_URL}${url}` : null;
  })
  .filter((value, index, array) => Boolean(value) && array.indexOf(value) === index)
  .filter((imageUrl) => imageUrl !== mainImage);



const priceFormatter = new Intl.NumberFormat("es-PE", {
  style: "currency",
  currency: "USD",
  minimumFractionDigits: 2,
});

const precio = typeof producto?.precio === "number" ? priceFormatter.format(producto.precio) : "Consultar";
const descripcion = producto?.descripcion ?? "Este producto aún no tiene una descripción detallada disponible.";
const stock = typeof producto?.cantidad_stock === "number" ? producto.cantidad_stock : null;
---

<BaseLayout global={global}>
  <article class="z-40 mx-auto flex max-w-6xl flex-col gap-12 px-6 py-12">
    <button
      type="button"
      onclick="window.history.back()"
      class="inline-flex items-center gap-2 w-auto cursor-pointer self-start text-sm font-bold text-primary hover:underline"
    >
      ← Volver a la tienda
    </button>
    <div class="grid gap-10 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
      <section class="space-y-6">
        <div class="overflow-hidden rounded-3xl shadow-7xl border border-zinc-200 bg-white p-4 dark:border-zinc-800 dark:bg-zinc-900">
          <img
            id="main-image"
            src={mainImage}
            alt={producto?.nombre ?? "Producto"}
            class="h-full w-full max-h-[480px] rounded-2xl object-contain bg-white p-4 dark:bg-zinc-900"
            loading="lazy"
          />
        </div>
        {galleryItems.length > 0 && (
          <div id="thumbs" class="grid grid-cols-2 gap-4 sm:grid-cols-4">
            {galleryItems.map((imageUrl) => (
              <button
              class="cursor-pointer thumb relative overflow-hidden rounded-2xl border border-zinc-200 bg-white p-2 dark:border-zinc-800 dark:bg-zinc-900"
              data-src={imageUrl}
              type="button"
              aria-label="Cambiar imagen"
            >
              <img
                src={imageUrl}
                alt={`Vista adicional de ${producto?.nombre}`}
                class="h-32 w-full object-cover pointer-events-none"
                loading="lazy"
              />
            </button>
            ))}
          </div>
        )}
      </section>

      <section class="flex flex-col gap-6 rounded-3xl border border-zinc-200 bg-white p-8 shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
        <header class="space-y-2">
          <span class="inline-flex items-center rounded-full bg-primary/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-primary">
            {categoriaActual?.nombre  ?? "Sin categoría"}
          </span>
          <h1 class="text-3xl font-bold text-zinc-900 dark:text-white">{producto?.nombre}</h1>
          <p class="text-sm text-zinc-500 dark:text-zinc-400">Código: {producto?.codigo ?? "N/A"}</p>
        </header>

        <div class="space-y-1">
          <p class="text-3xl font-bold text-red-500">{precio}</p>
          {stock !== null ? (
            <p class="text-sm text-zinc-500 dark:text-zinc-400">Stock disponible: {stock} unidades</p>
          ) : null}
        </div>

        <section class="space-y-4">
          <h2 class="text-lg font-semibold text-zinc-900 dark:text-white">Descripción</h2>
          <p class="leading-relaxed text-zinc-600 dark:text-zinc-300">{descripcion}</p>
        </section>

        <section class="space-y-4">
          <h2 class="text-lg font-semibold text-zinc-900 dark:text-white">Características destacadas</h2>
          <ul class="grid list-disc gap-2 pl-5 text-sm text-zinc-600 dark:text-zinc-300">
            <li>Identificador interno: {producto?.documentId ?? "-"}</li>
            <li>Estado: {producto?.estado === "A" ? "Disponible" : producto?.estado ?? "No especificado"}</li>
            <li>Última actualización: {new Date(producto?.updatedAt ?? producto?.createdAt ?? Date.now()).toLocaleDateString("es-PE")}</li>
          </ul>
        </section>

        <div class="flex flex-col gap-3 sm:flex-row">
           <button
                type="button"
                data-action="add-to-cart"
                class="w-full cursor-pointer rounded-full bg-primary px-4 py-2 text-sm font-semibold text-white transition hover:brightness-110"
                data-product-id={producto?.id ?? producto?.ID_Producto ?? producto?.codigo ?? slug}
                data-product-name={producto?.nombre ?? "Producto"}
                data-product-price={typeof producto?.precio === "number" ? producto.precio : ""}
                data-product-image={mainImage}
                data-product-url={`/producto/${slug}`}
                >
                Añadir al carrito
            </button>
          <a
            href="/tienda#contacto"
            class="w-full rounded-full border border-primary px-6 py-3 text-center text-sm font-semibold text-primary transition hover:bg-primary/10"
          >
            Contactar un asesor
          </a>
        </div>
      </section>
    </div>
  </article>
</BaseLayout>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const mainImg = document.getElementById("main-image");
    const thumbsRoot = document.getElementById("thumbs");
    if (!mainImg || !thumbsRoot) return;

    // Estado: URLs absolutas
    const mainState = { src: mainImg.getAttribute("src") };
    let thumbs = Array.from(thumbsRoot.querySelectorAll("[data-src]"))
      .map((el) => el.getAttribute("data-src"))
      .filter(Boolean);

    // Delegación de eventos para clicks en las miniaturas
    thumbsRoot.addEventListener("click", (e) => {
      const btn = (e.target as HTMLElement).closest("[data-src]");
      if (!btn) return;

      const newMain = btn.getAttribute("data-src");
      if (!newMain || newMain === mainState.src) return;

      // 1) Cambia imagen principal
      const prevMain = mainState.src;
      mainState.src = newMain;
      mainImg.setAttribute("src", newMain);

      // 2) Reordena: quita clicada y agrega la anterior principal al final
      thumbs = thumbs.filter((u) => u !== newMain);
      thumbs.push(prevMain);

      // 3) Re-renderiza miniaturas
      renderThumbs();
    });

    function renderThumbs() {
      // Limpia y vuelve a dibujar
      thumbsRoot.innerHTML = thumbs
        .map(
          (src) => `
          <button
            class="cursor-pointer thumb relative overflow-hidden rounded-2xl border border-zinc-200 bg-white p-2 dark:border-zinc-800 dark:bg-zinc-900"
            data-src="${src}"
            type="button"
            aria-label="Cambiar imagen"
          >
            <img src="${src}" alt="Vista adicional" class="h-32 w-full object-cover pointer-events-none" loading="lazy" />
          </button>`
        )
        .join("");
    }
  });
</script>
