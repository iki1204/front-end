---
import BaseLayout from "../../layouts/Layout.astro";
import Container from "../../components/Container.astro";
import { BlocksRenderer} from "@strapi/blocks-react-renderer";
import { getProductoBySlug, getGlobalData, getCategorias, getProductos, getMarcas } from "../../lib/api";

const normalizeCollection = (collection: any[] = []) =>
  collection.map((item) => (item?.attributes ? { id: item.id, ...item.attributes } : item));

export async function getStaticPaths() {
  const PAGE_SIZE = 100;
  const productos: Record<string, unknown>[] = [];
  let page = 1;
  let pageCount = 1;

  do {
    const response = await getProductos({
      "pagination[page]": page,
      "pagination[pageSize]": PAGE_SIZE,
    });

    const pageItems = normalizeCollection(response?.data ?? []);
    productos.push(...pageItems);

    const pagination = response?.meta?.pagination;
    pageCount = pagination?.pageCount ?? pageCount;
    page += 1;
  } while (page <= pageCount);

  return productos
    .map((producto) => {
      const slug = producto?.ID_Nombre ?? producto?.slug ?? (producto?.id ? String(producto.id) : null);

      if (!slug) {
        return null;
      }

      return {
        params: { slug },
        props: { preloadedProducto: producto },
      };
    })
    .filter(
      (
        value,
      ): value is {
        params: { slug: string };
        props: { preloadedProducto: Record<string, unknown> };
      } => Boolean(value),
    );
}

const { params } = Astro;
const slug = params.slug;
const preloadedProducto = Astro.props?.preloadedProducto;

if (!slug) {
  throw new Error("No se proporcionó un identificador de producto");
}

const [productoResponse, global, categoriasResponse, marcasResponse] = await Promise.all([
  preloadedProducto ? Promise.resolve({ data: [preloadedProducto] }) : getProductoBySlug(slug),
  getGlobalData(),
  getCategorias(),
  getMarcas()
]);

const producto = normalizeCollection(productoResponse?.data ?? [])[0];

if (!producto) {
  return Astro.redirect("/tienda", 302);
}

const categorias = normalizeCollection(categoriasResponse?.data ?? []);
const marcas = normalizeCollection(marcasResponse?.data ?? []);
const categoriaActual = categorias.find((categoria) =>
  categoria?.ID_Categoria === producto?.ID_Categoria || categoria?.id === producto?.ID_Categoria
);
const marcaActual = marcas.find((marca) =>
  marca?.ID_Marca === producto?.ID_Marca || null
)



const API_URL = import.meta.env.VITE_STRAPI_URL;
const galeriasPosibles = [producto?.imagen, producto?.imagenes?.data];

const firstArray = galeriasPosibles.find(a => Array.isArray(a) && a.length);
const firstItem = firstArray?.[0] ?? null;
const mainPath =
  firstItem?.formats?.medium?.url ??
  firstItem?.formats?.large?.url ??
  firstItem?.url ??
  firstItem?.attributes?.formats?.medium?.url ??
  firstItem?.attributes?.url ??
  null;
const mainImage = mainPath ? `${API_URL}${mainPath}` : "/images/placeholder.svg";
const galleryItems = galeriasPosibles
  .flat()
  .filter(Boolean)
  .map((item) => {
    const url = item?.url ?? item?.attributes?.url ?? item?.attributes?.formats?.medium?.url ?? null;
    return url && API_URL ? `${API_URL}${url}` : null;
  })
  .filter((value, index, array) => Boolean(value) && array.indexOf(value) === index)
  .filter((imageUrl) => imageUrl !== mainImage);

  
const datasheetEntries: any[] = [
  ...(Array.isArray(producto?.datasheets) ? producto.datasheets : []),
  ...(Array.isArray(producto?.datasheets?.data)
    ? producto.datasheets.data.map((item: any) => item?.attributes ?? item)
    : []),
  ...(producto?.datasheets?.data?.attributes ? [producto.datasheets.data.attributes] : []),
].filter(Boolean);

const MAX_DATASHEET_LABEL_LENGTH = 15;

const truncateLabel = (label: string, maxLength = MAX_DATASHEET_LABEL_LENGTH) =>
  label.length > maxLength ? `${label.slice(0, maxLength - 1)}…` : label;

const datasheetLinks = datasheetEntries
  .map((item) => {
    const url = item?.url ?? item?.formats?.pdf?.url ?? null;
    if (!url) return null;

    const absoluteUrl = url.startsWith("http") ? url : `${API_URL ?? ""}${url}`;
    const label = item?.name ?? item?.alternativeText ?? item?.caption ?? "Ficha técnica";
    const displayLabel = truncateLabel(label);

    return { url: absoluteUrl, label, displayLabel };
  })
  .filter(Boolean);


const priceFormatter = new Intl.NumberFormat("es-PE", {
  style: "currency",
  currency: "USD",
  minimumFractionDigits: 2,
});

const findPriceByType = (tipo: number) => {
  const keyCandidates: Record<number, string[]> = {
    1: ["precio"],
    2: ["Precio2"],
    3: ["Precio3"],
  };

  const candidates = keyCandidates[tipo] ?? [];

  for (const key of candidates) {
    const value = producto?.[key as keyof typeof producto];
    if (typeof value === "number") {
      return value;
    }
  }

  return null;
};

const rawPrices: Record<string, number | null> = {
  default: null,
  1: findPriceByType(1),
  2: findPriceByType(2),
  3: findPriceByType(3),
};

rawPrices.default = rawPrices[1] ?? (typeof producto?.precio === "number" ? producto.precio : null);

const formattedPrices: Record<string, string> = Object.fromEntries(
  Object.entries(rawPrices).map(([key, value]) => [
    key,
    typeof value === "number" ? priceFormatter.format(value) : "Consultar",
  ]),
);



const precio = formattedPrices.default;

var descripcion = producto?.descripcion;

const stock = typeof producto?.cantidad_stock === "number" ? producto.cantidad_stock : null;
---

<BaseLayout global={global}>
  <Container>
    <article class="relative mx-auto max-w-6xl px-4 py-12 sm:px-6 lg:px-10">
      <div class="mb-8 flex flex-wrap items-center justify-between gap-4">
        <button
          type="button"
          onclick="window.history.back()"
          class="inline-flex cursor-pointer items-center gap-2 rounded-full border border-primary/20 bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:border-primary/40 hover:bg-primary/15"
        >
          <span aria-hidden>←</span> Volver a la tienda
        </button>
        <p class="text-xs font-medium uppercase tracking-[0.25em] text-zinc-600 dark:text-zinc-300">Ficha de producto</p>
      </div>

      <div class="grid gap-8 lg:grid-cols-[1.05fr_0.95fr] xl:grid-cols-[1.15fr_0.85fr]">
        <section class="relative space-y-5 rounded-3xl sm:p-7 lg:p-8">
          <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex flex-wrap items-center gap-2">
              <span class="inline-flex items-center gap-2 rounded-full bg-red-500 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-white  dark:bg-primary">
                <span class="h-2 w-2 rounded-full bg-white"></span>
                {categoriaActual?.nombre ?? "Sin categoría"}
              </span>
              <span class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-700 dark:bg-emerald-200 dark:text-emerald-900">
                <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                {marcaActual?.nombre ?? "Sin marca"}
              </span>
            </div>
            <p class="text-xs font-semibold text-zinc-500 dark:text-zinc-400">Código: {producto?.codigo ?? "N/A"}</p>
          </header>

          <div class="overflow-hidden rounded-2xl border border-zinc-200 bg-gradient-to-br from-zinc-50 via-white to-zinc-100 shadow-inner dark:border-zinc-800 dark:from-zinc-900 dark:via-zinc-950 dark:to-zinc-900">
              <div class="relative flex items-center justify-center px-4 py-6 sm:px-6">
              <div class="flex h-[320px] w-full max-w-[520px] items-center justify-center overflow-hidden rounded-xl sm:h-[420px] lg:h-[520px]">
                <img
                  id="main-image"
                  src={mainImage}
                  alt={producto?.nombre ?? "Producto"}
                  class="h-full w-full object-contain"
                  loading="lazy"
                />
              </div>
          </div>

          {galleryItems.length > 0 && (
            <div class="space-y-3">
              <p class="text-xs px-3 font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Galería</p>
              <div
                id="thumbs"
                class="grid grid-flow-col auto-cols-[minmax(110px,1fr)] gap-3 overflow-x-auto rounded-2xl border border-dashed border-zinc-200 bg-white/80 p-2 shadow-sm dark:border-zinc-800 dark:bg-zinc-900/60 sm:grid-flow-row sm:grid-cols-4 sm:overflow-visible"
              >
                {galleryItems.map((imageUrl) => (
                  <button
                    class="thumb relative h-24 w-full cursor-pointer overflow-hidden rounded-xl border border-zinc-200 bg-zinc-50 p-2 transition hover:-translate-y-0.5 hover:shadow-md dark:border-zinc-800 dark:bg-zinc-900 sm:h-28"
                    data-src={imageUrl}
                    type="button"
                    aria-label="Cambiar imagen"
                  >
                    <img
                      src={imageUrl}
                      alt={`Vista adicional de ${producto?.nombre}`}
                      class="h-full w-full object-cover pointer-events-none"
                      loading="lazy"
                    />
                  </button>
                ))}
              </div>
            </div>
          )}
        </section>

        <section class="relative flex flex-col gap-6 rounded-3xl border border-zinc-200 bg-white/90 p-6 shadow-xl shadow-primary/5 backdrop-blur dark:border-zinc-800 dark:bg-zinc-900/85 lg:sticky lg:top-6 lg:self-start lg:p-8">
          <div class="space-y-3">
            <p class="text-xs font-semibold uppercase tracking-[0.18em] text-primary">Producto</p>
            <h1 class="w-full break-words text-3xl font-black leading-tight text-zinc-900 dark:text-white sm:text-4xl">{producto?.nombre}</h1>
          </div>

          <div class="rounded-2xl border border-primary/20 bg-primary/5 px-5 py-4 shadow-inner dark:border-primary/30 dark:bg-primary/10">
            <p class="hidden text-4xl font-extrabold text-primary" data-auth-visible="authenticated" data-precio-display>{precio}</p>
            <p class="text-sm text-primary" data-auth-visible="guest">Inicia sesión para ver mas de este producto.</p>
            {stock !== null ? (
              <p class="mt-2 inline-flex items-center gap-2 rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-100">
                Stock disponible: {stock} unidades
              </p>
            ) : null}
          </div>

          <section class="space-y-4">
            <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-zinc-500 dark:text-zinc-400">
              <span class="h-[1px] flex-1 bg-gradient-to-r from-transparent via-zinc-300 to-transparent dark:via-zinc-700"></span>
              <span>Descripción</span>
              <span class="h-[1px] flex-1 bg-gradient-to-r from-transparent via-zinc-300 to-transparent dark:via-zinc-700"></span>
            </div>
            <div class="prose overflow-x-auto break-words prose-sm max-w-none text-zinc-800 dark:prose-invert dark:text-zinc-100">
              {Array.isArray(descripcion) && descripcion.length > 0 && descripcion.some((block) => Array.isArray(block.children) && block.children.length > 0)
                ? <BlocksRenderer content={descripcion} />
                : <p class="text-sm">No hay descripción para este producto.</p>
              }
            </div>
          </section>

          {datasheetLinks.length > 0 ? (
            <section class="space-y-3" data-auth-visible="authenticated">
              <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-zinc-500 dark:text-zinc-400">
                <span class="h-[1px] flex-1 bg-gradient-to-r from-transparent via-zinc-300 to-transparent dark:via-zinc-700"></span>
                <span>Fichas técnicas</span>
                <span class="h-[1px] flex-1 bg-gradient-to-r from-transparent via-zinc-300 to-transparent dark:via-zinc-700"></span>
              </div>
              <ul class="space-y-2 text-sm text-zinc-700 dark:text-zinc-200">
                {datasheetLinks.map((file) => (
                  <li class="flex w-full max-w-full items-center overflow-hidden gap-3 rounded-xl border border-zinc-200 bg-white/70 px-4 py-3 shadow-sm transition hover:border-primary/40 hover:shadow-md dark:border-zinc-800 dark:bg-zinc-900">
                    <span class="flex h-10 w-10 items-center justify-center rounded-lg bg-primary/10 text-primary">
                      <svg viewBox="0 0 24 24" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path
                          fill-rule="evenodd"
                          clip-rule="evenodd"
                          d="M12.25 2.83422C11.7896 2.75598 11.1622 2.75005 10.0298 2.75005C8.11311 2.75005 6.75075 2.75163 5.71785 2.88987C4.70596 3.0253 4.12453 3.27933 3.7019 3.70195C3.27869 4.12516 3.02502 4.70481 2.88976 5.7109C2.75159 6.73856 2.75 8.09323 2.75 10.0001V14.0001C2.75 15.9069 2.75159 17.2615 2.88976 18.2892C3.02502 19.2953 3.27869 19.8749 3.7019 20.2981C4.12511 20.7214 4.70476 20.975 5.71085 21.1103C6.73851 21.2485 8.09318 21.2501 10 21.2501H14C15.9068 21.2501 17.2615 21.2485 18.2892 21.1103C19.2952 20.975 19.8749 20.7214 20.2981 20.2981C20.7213 19.8749 20.975 19.2953 21.1102 18.2892C21.2484 17.2615 21.25 15.9069 21.25 14.0001V13.5629C21.25 12.0269 21.2392 11.2988 21.0762 10.7501H17.9463C16.8135 10.7501 15.8877 10.7501 15.1569 10.6518C14.3929 10.5491 13.7306 10.3268 13.2019 9.79815C12.6732 9.26945 12.4509 8.60712 12.3482 7.84317C12.25 7.1123 12.25 6.18657 12.25 5.05374V2.83422ZM13.75 3.6095V5.00005C13.75 6.19976 13.7516 7.0241 13.8348 7.64329C13.9152 8.24091 14.059 8.53395 14.2626 8.73749C14.4661 8.94103 14.7591 9.08486 15.3568 9.16521C15.976 9.24846 16.8003 9.25005 18 9.25005H20.0195C19.723 8.9625 19.3432 8.61797 18.85 8.17407L14.8912 4.61117C14.4058 4.17433 14.0446 3.85187 13.75 3.6095ZM10.1755 1.25002C11.5601 1.24965 12.4546 1.24942 13.2779 1.56535C14.1012 1.88129 14.7632 2.47735 15.7873 3.39955C15.8226 3.43139 15.8584 3.46361 15.8947 3.49623L19.8534 7.05912C19.8956 7.09705 19.9372 7.1345 19.9783 7.17149C21.162 8.23614 21.9274 8.92458 22.3391 9.84902C22.7508 10.7734 22.7505 11.8029 22.75 13.3949C22.75 13.4502 22.75 13.5062 22.75 13.5629V14.0565C22.75 15.8942 22.75 17.3499 22.5969 18.4891C22.4392 19.6615 22.1071 20.6104 21.3588 21.3588C20.6104 22.1072 19.6614 22.4393 18.489 22.5969C17.3498 22.7501 15.8942 22.7501 14.0564 22.7501H9.94359C8.10583 22.7501 6.65019 22.7501 5.51098 22.5969C4.33856 22.4393 3.38961 22.1072 2.64124 21.3588C1.89288 20.6104 1.56076 19.6615 1.40314 18.4891C1.24997 17.3499 1.24998 15.8942 1.25 14.0565V9.94363C1.24998 8.10587 1.24997 6.65024 1.40314 5.51103C1.56076 4.33861 1.89288 3.38966 2.64124 2.64129C3.39019 1.89235 4.34232 1.56059 5.51887 1.40313C6.66283 1.25002 8.1257 1.25003 9.97352 1.25005L10.0298 1.25005C10.0789 1.25005 10.1275 1.25004 10.1755 1.25002Z"
                          fill="currentColor"
                        ></path>
                        <path
                          fill-rule="evenodd"
                          clip-rule="evenodd"
                          d="M7.98705 19.0472C8.27554 19.3177 8.72446 19.3177 9.01296 19.0472L11.013 17.1722C11.3151 16.8889 11.3305 16.4143 11.0472 16.1121C10.7639 15.8099 10.2892 15.7946 9.98705 16.0779L9.25 16.7689V13.5001C9.25 13.0858 8.91421 12.7501 8.5 12.7501C8.08579 12.7501 7.75 13.0858 7.75 13.5001V16.7689L7.01296 16.0779C6.71077 15.7946 6.23615 15.8099 5.95285 16.1121C5.66955 16.4143 5.68486 16.8889 5.98705 17.1722L7.98705 19.0472Z"
                          fill="currentColor"
                        ></path>
                      </svg>
                    </span>
                    <a
                      href={file.url}
                      target="_blank"
                      rel="noreferrer"
                      class="flex-1 min-w-0 truncate font-semibold text-primary hover:underline"
                      title={file.label}
                    >
                      <span class="block truncate sm:hidden">{file.displayLabel}</span>
                      <span class="hidden sm:block break-words">{file.label}</span>
                    </a>
                    <span class="text-[11px] font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">PDF</span>
                  </li>
                ))}
              </ul>
            </section>
          ) : null}

          <div class="flex flex-col gap-3 sm:flex-row">
            <button
              type="button"
              data-auth-visible="authenticated"
              data-action="add-to-cart"
              class="w-full cursor-pointer rounded-full bg-primary px-5 py-3 text-sm font-semibold text-white transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-primary/30"
              data-product-id={producto?.id ?? producto?.ID_Producto ?? producto?.codigo ?? slug}
              data-product-name={producto?.nombre ?? "Producto"}
              data-product-price={typeof producto?.precio === "number" ? producto.precio : ""}
              data-product-image={mainImage}
              data-product-url={`/producto/${slug}`}
            >
              Añadir al carrito
            </button>
            <a
              href="/tienda#contacto"
              class="w-full rounded-full border border-primary/40 px-6 py-3 text-center text-sm font-semibold text-primary transition hover:-translate-y-0.5 hover:bg-primary/10 hover:shadow-lg hover:shadow-primary/20"
            >
              Contactar un asesor
            </a>
          </div>
        </section>
      </div>
    </article>
  </Container>
</BaseLayout>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const mainImg = document.getElementById("main-image");
    const thumbsRoot = document.getElementById("thumbs");
    if (!mainImg || !thumbsRoot) return;

    // Estado: URLs absolutas
    const mainState = { src: mainImg.getAttribute("src") };
    let thumbs = Array.from(thumbsRoot.querySelectorAll("[data-src]"))
      .map((el) => el.getAttribute("data-src"))
      .filter(Boolean);

    // Delegación de eventos para clicks en las miniaturas
    thumbsRoot.addEventListener("click", (e) => {
      const btn = (e.target as HTMLElement).closest("[data-src]");
      if (!btn) return;

      const newMain = btn.getAttribute("data-src");
      if (!newMain || newMain === mainState.src) return;

      // 1) Cambia imagen principal
      const prevMain = mainState.src;
      mainState.src = newMain;
      mainImg.setAttribute("src", newMain);

      // 2) Reordena: quita clicada y agrega la anterior principal al final
      thumbs = thumbs.filter((u) => u !== newMain);
      thumbs.push(prevMain);

      // 3) Re-renderiza miniaturas
      renderThumbs();
    });

    function renderThumbs() {
      // Limpia y vuelve a dibujar
      thumbsRoot.innerHTML = thumbs
        .map(
          (src) => `
          <button
            class="thumb relative h-24 min-w-[96px] cursor-pointer overflow-hidden rounded-2xl border border-zinc-300 bg-white p-2 shadow-sm dark:border-zinc-800 dark:bg-zinc-900 sm:h-28"
            data-src="${src}"
            type="button"
            aria-label="Cambiar imagen"
          >
            <img src="${src}" alt="Vista adicional" class="h-full w-full object-cover pointer-events-none" loading="lazy" />
          </button>`
        )
        .join("");
    }
  });
</script>
