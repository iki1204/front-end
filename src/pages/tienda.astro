---
import BaseLayout from "../layouts/Layout.astro";
import ProductCard from "../components/ProductCard.astro";
import { getProductos, getCategorias, getGlobalData } from "../lib/api";

const url = new URL(Astro.request.url);
const rawSearchParam = url.searchParams.get("search") ?? "";
const searchParam = url.searchParams.get("search")?.toLowerCase().trim() ?? "";
const categoryParam = url.searchParams.get("category") ?? "all";
const pageParam = Number.parseInt(url.searchParams.get("page") ?? "1", 10);
const ITEMS_PER_PAGE = 24;

const requestedPage = Number.isFinite(pageParam) && pageParam > 0 ? pageParam : 1;

const strapiParams = new URLSearchParams();
strapiParams.set("pagination[page]", String(requestedPage));
strapiParams.set("pagination[pageSize]", String(ITEMS_PER_PAGE));

if (categoryParam !== "all") {
  strapiParams.set("filters[ID_Categoria][$eq]", categoryParam);
}

if (searchParam.length > 0) {
  strapiParams.set("filters[$or][0][nombre][$containsi]", searchParam);
  strapiParams.set("filters[$or][1][codigo][$containsi]", searchParam);
}

strapiParams.set("sort", "nombre:asc");

const [productosResponse, categoriasResponse, global] = await Promise.all([
  getProductos(strapiParams),
  getCategorias(),
  getGlobalData(),
]);

const normalizeCollection = (collection: any[] = []) =>
  collection.map((item) => (item?.attributes ? { id: item.id, ...item.attributes } : item));

const productos = normalizeCollection(productosResponse?.data ?? []);
const categorias = normalizeCollection(categoriasResponse?.data ?? []);
const paginationMeta = productosResponse?.meta?.pagination ?? {};
const totalPages = Math.max(1, paginationMeta.pageCount ?? 1);
const currentPage = Math.min(Math.max(paginationMeta.page ?? requestedPage, 1), totalPages);
const totalItems = paginationMeta.total ?? productos.length;

const buildQueryString = (updates: Record<string, string | number | null>) => {
  const params = new URLSearchParams(url.searchParams);

  Object.entries(updates).forEach(([key, value]) => {
    if (value === null || value === "") {
      params.delete(key);
    } else {
      params.set(key, String(value));
    }
  });

  if (updates.page) {
    params.set("page", String(updates.page));
  } else if (updates.page === null) {
    params.delete("page");
  }

  const query = params.toString();
  return query ? `?${query}` : "";
};

const categoryItems = [
  { label: "Todos", value: "all" },
  ...categorias.map((categoria) => ({
    label: categoria?.nombre ?? "Sin nombre",
    value: categoria?.ID_Categoria ?? categoria?.id,
  })),
];
---



<BaseLayout global={global}>
  <section class="mx-auto flex max-w-7xl flex-col gap-10 pt-20 px-0 py-10">
    <header class="flex flex-col gap-6 rounded-3xl border border-zinc-200 bg-white p-8 shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
      <div class="flex flex-col gap-2">
        <h1 class="text-3xl font-bold text-zinc-900 dark:text-white">Tienda</h1>
        <p class="text-zinc-600 dark:text-zinc-300">
          Explora nuestro catálogo y encuentra el equipo que necesitas. Utiliza la barra de búsqueda o filtra por categoría.
        </p>
        
      </div>
      <form method="get" class="flex flex-col gap-4 md:flex-row">
        <div class="relative flex-1">
          <input
            type="search"
            name="search"
            placeholder="Buscar por nombre o código"
            value={searchParam}
            class="w-full rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-900 shadow-inner focus:border-primary focus:outline-none dark:border-zinc-700 dark:bg-zinc-800 dark:text-white"
          />
          <span class="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 text-zinc-400">⌕</span>
        </div>
        <input type="hidden" name="category" value={categoryParam} />
        <input type="hidden" name="page" value="1" />
        <button
          type="submit"
          class="rounded-2xl bg-primary px-6 py-3 text-sm font-semibold text-white transition hover:brightness-110"
        >
          Buscar
        </button>
      </form>
      <nav aria-label="Categorías" class="overflow-x-auto">
        <ul class="flex min-w-full gap-3">
          {categoryItems.map((item) => {
            const isActive = item.value === categoryParam;
            return (
              <li>
                <a
                  href={buildQueryString({ category: item.value, page: 1 })}
                  class={`whitespace-nowrap rounded-full border px-5 py-2 text-sm font-medium transition ${
                    isActive
                      ? "border-primary bg-primary text-white"
                      : "border-zinc-200 bg-white text-zinc-700 hover:border-primary hover:text-primary dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-200"
                  }`}
                >
                  {item.label}
                </a>
              </li>
            );
          })}
        </ul>
      </nav>
      <p class="text-sm text-zinc-500 dark:text-zinc-400">
        Mostrando
        <strong class="mx-1">{productos.length}</strong>
        de
        <strong class="ml-1">{totalItems}</strong>
        productos disponibles.
      </p>
    </header>

    {productos.length > 0 ? (
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
        {productos.map((producto) => (
          <ProductCard producto={producto} />
        ))}
      </div>
    ) : (
      <div class="rounded-3xl border border-dashed border-zinc-300 bg-white p-12 text-center dark:border-zinc-700 dark:bg-zinc-900">
        <h2 class="text-xl font-semibold text-zinc-900 dark:text-white">No encontramos resultados</h2>
        <p class="mt-2 text-sm text-zinc-500 dark:text-zinc-400">
          Ajusta los filtros de búsqueda para ver otros productos.
        </p>
      </div>
    )}

    {totalPages > 1 && (
      <nav aria-label="Paginación" class="flex items-center justify-center gap-2">
        <a
          href={buildQueryString({ page: Math.max(1, currentPage - 1) })}
          class={`rounded-full px-4 py-2 text-sm font-medium transition ${
            currentPage === 1
              ? "cursor-not-allowed bg-zinc-100 text-zinc-400 dark:bg-zinc-800 dark:text-zinc-600"
              : "bg-white text-zinc-700 hover:border-primary hover:text-primary dark:bg-zinc-900 dark:text-zinc-200"
          }`}
          aria-disabled={currentPage === 1}
        >
          Anterior
        </a>
        {Array.from({ length: totalPages }).map((_, index) => {
          const pageNumber = index + 1;
          const isActive = pageNumber === currentPage;
          return (
            <a
              href={buildQueryString({ page: pageNumber })}
              class={`flex h-10 w-10 items-center justify-center rounded-full text-sm font-semibold transition ${
                isActive
                  ? "bg-primary text-white"
                  : "bg-white text-zinc-700 hover:border-primary hover:text-primary dark:bg-zinc-900 dark:text-zinc-200"
              }`}
              aria-current={isActive ? "page" : undefined}
            >
              {pageNumber}
            </a>
          );
        })}
        <a
          href={buildQueryString({ page: Math.min(totalPages, currentPage + 1) })}
          class={`rounded-full px-4 py-2 text-sm font-medium transition ${
            currentPage === totalPages
              ? "cursor-not-allowed bg-zinc-100 text-zinc-400 dark:bg-zinc-800 dark:text-zinc-600"
              : "bg-white text-zinc-700 hover:border-primary hover:text-primary dark:bg-zinc-900 dark:text-zinc-200"
          }`}
          aria-disabled={currentPage === totalPages}
        >
          Siguiente
        </a>
      </nav>
    )}
  </section>
</BaseLayout>
